import React, { useMemo } from "react";
import {
  LayerGroup,
  LayerId,
  LayerLeaf,
  LayerNode,
  LayerStack,
  flattenLayerTree,
} from "@/lib/battlemap/layers";

type Tint = { color: string; alpha: number };

type BattlemapLayersPanelProps = {
  layers: LayerStack;
  selectedLayerIds: string[];
  soloLayerId: string | null;
  tintState: Record<string, Tint | null>;
  presets?: Array<{ id: string; name: string; visibleLayerIds: LayerId[] }>;
  onLayersChange: (next: LayerStack) => void;
  onSelectedLayerIdsChange: (ids: string[]) => void;
  onSoloLayerChange: (id: string | null) => void;
  onTintChange: (layerId: string, tint: Tint | null) => void;
  onCreateLayer: (parentId: string | null) => void;
  onCreateGroup: (parentId: string | null) => void;
  onDuplicateLayer: (layerId: string) => void;
  onDeleteLayers: (layerIds: string[]) => void;
  onReorder: (dragId: string, targetId: string, position: "above" | "inside" | "below") => void;
  onToggleVisibility: (nodeId: string) => void;
  onToggleLock: (nodeId: string) => void;
  onRenameLayer: (nodeId: string, name: string) => void;
  onToggleOutline: (layerId: string, value: boolean) => void;
  onToggleShadow: (layerId: string, value: boolean) => void;
};

const iconButtonStyle: React.CSSProperties = {
  border: "1px solid #dfe6e9",
  borderRadius: 6,
  background: "#fff",
  cursor: "pointer",
  width: 26,
  height: 26,
  display: "inline-flex",
  alignItems: "center",
  justifyContent: "center",
};

const LockIcon: React.FC<{ locked: boolean }> = ({ locked }) => (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    {locked ? (
      <>
        <rect x="5" y="11" width="14" height="9" rx="2" ry="2" />
        <path d="M8 11V7a4 4 0 0 1 8 0v4" />
      </>
    ) : (
      <>
        <rect x="5" y="11" width="14" height="9" rx="2" ry="2" />
        <path d="M12 15v2" />
        <path d="M8 11V7a4 4 0 0 1 7.5-2" />
      </>
    )}
  </svg>
);

const FolderIcon: React.FC = () => (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M3 6h5l2 2h11v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z" />
    <path d="M3 6v12a2 2 0 0 0 2 2h14" />
  </svg>
);

const PlusIcon: React.FC = () => (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="12" y1="5" x2="12" y2="19" />
    <line x1="5" y1="12" x2="19" y2="12" />
  </svg>
);

const TrashIcon: React.FC = () => (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="3 6 5 6 21 6" />
    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
    <path d="M10 11v6" />
    <path d="M14 11v6" />
    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
  </svg>
);

const LayerRow: React.FC<{
  node: LayerNode;
  depth: number;
  isSelected: boolean;
  soloActive: boolean;
  isSolo: boolean;
  onClick: (e: React.MouseEvent, nodeId: string) => void;
  onVisibilityClick: (e: React.MouseEvent, nodeId: string) => void;
  onToggleExpand: (nodeId: string) => void;
  onDelete: (nodeId: string) => void;
}> = ({ node, depth, isSelected, soloActive, isSolo, onClick, onVisibilityClick, onToggleExpand, onDelete }) => {
  const paddingLeft = 8 + depth * 14;
  const showExpand = node.type === "group";
  return (
    <div
      onClick={(e) => onClick(e, node.id)}
      style={{
        display: "grid",
        gridTemplateColumns: "28px 18px 1fr 32px",
        gap: 8,
        alignItems: "center",
        padding: "5px 6px",
        borderRadius: 6,
        background: isSelected ? "rgba(78,141,245,0.12)" : "#fff",
        border: isSelected ? "1px solid #4e8df5" : "1px solid #e5e7eb",
        cursor: "pointer",
        minHeight: 34,
      }}
    >
      <div style={{ display: "flex", gap: 6, alignItems: "center", paddingLeft }}>
        <button
          type="button"
          onClick={(e) => {
            e.stopPropagation();
            onVisibilityClick(e, node.id);
          }}
          style={{
            ...iconButtonStyle,
            background: isSolo ? "rgba(78,141,245,0.2)" : node.visible ? "#fff" : "#f1f3f5",
          }}
          aria-label="Toggle visibility"
        >
          {node.visible ? "ðŸ‘" : "ðŸš«"}
        </button>
      </div>

      <div
        style={{
          width: 18,
          height: 18,
          border: "1px solid #dfe6e9",
          borderRadius: 2,
          background:
            "linear-gradient(45deg, #f5f7f9 25%, transparent 25%, transparent 50%, #f5f7f9 50%, #f5f7f9 75%, transparent 75%, transparent)",
          backgroundSize: "8px 8px",
          boxShadow: "inset 0 0 0 1px #fff",
        }}
      />

      <div style={{ display: "flex", alignItems: "center", gap: 8, minWidth: 0 }}>
        {showExpand ? (
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              onToggleExpand(node.id);
            }}
            style={iconButtonStyle}
            aria-label={node.expanded ? "Collapse" : "Expand"}
          >
            {node.expanded ? "â–¾" : "â–¸"}
          </button>
        ) : (
          <div style={{ width: 26 }} />
        )}
        <div style={{ fontWeight: 600, fontSize: 12, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
          {node.name}
          {soloActive && isSolo ? " (Solo)" : ""}
        </div>
      </div>

      <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
        {node.type === "layer" && node.role !== "background" && node.role !== "grid" && node.role !== "tokens" && node.role !== "fog" ? (
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              onDelete(node.id);
            }}
            style={iconButtonStyle}
            aria-label="Delete"
          >
            ðŸ—‘
          </button>
        ) : (
          <div style={{ width: 26 }} />
        )}
      </div>
    </div>
  );
};

const computeNextSelection = (
  flat: Array<{ node: LayerNode; depth: number }>,
  selected: string[],
  targetId: string,
  opts: { isMeta: boolean; isShift: boolean }
): string[] => {
  if (opts.isShift) {
    const ids = flat.filter((f) => f.node.type === "layer" || f.node.type === "group").map((f) => f.node.id);
    if (selected.length === 0) return [targetId];
    const last = selected[selected.length - 1];
    const start = ids.indexOf(last);
    const end = ids.indexOf(targetId);
    if (start === -1 || end === -1) return [targetId];
    const [lo, hi] = start < end ? [start, end] : [end, start];
    return ids.slice(lo, hi + 1);
  }
  if (opts.isMeta) {
    return selected.includes(targetId) ? selected.filter((id) => id !== targetId) : [...selected, targetId];
  }
  return [targetId];
};

const BattlemapLayersPanel: React.FC<BattlemapLayersPanelProps> = (props) => {
  const { layers, selectedLayerIds, soloLayerId, tintState } = props;

  const flat = useMemo(() => flattenLayerTree(layers, true, true), [layers]);
  const handleRowClick = (e: React.MouseEvent, nodeId: LayerId) => {
    const isMeta = e.metaKey || e.ctrlKey;
    const isShift = e.shiftKey;
    props.onSelectedLayerIdsChange(computeNextSelection(flat, selectedLayerIds, nodeId, { isMeta, isShift }));
  };

  const lockState = useMemo(() => {
    const selectedLayers = selectedLayerIds
      .map((id) => layers.nodes[id])
      .filter((n): n is LayerLeaf => n?.type === "layer");
    const anySelected = selectedLayers.length > 0;
    const anyUnlocked = selectedLayers.some((l) => !l.locked);
    const anyLocked = selectedLayers.some((l) => l.locked);
    const action = anySelected && anyUnlocked ? "lock" : "unlock";
    return { anySelected, anyUnlocked, anyLocked, action };
  }, [layers.nodes, selectedLayerIds]);

  const toggleLockForSelection = () => {
    if (!lockState.anySelected) return;
    const shouldLock = lockState.action === "lock";
    selectedLayerIds.forEach((id) => {
      const node = layers.nodes[id];
      if (node?.type === "layer") {
        if (shouldLock && !node.locked) props.onToggleLock(id);
        if (!shouldLock && node.locked) props.onToggleLock(id);
      }
    });
  };

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 8, height: "100%", minHeight: 0 }}>
      <div className="battlemap-card" style={{ flex: 1, display: "flex", flexDirection: "column", minHeight: 0 }}>
        <div className="battlemap-card__title">Layers</div>
        <div style={{ display: "flex", gap: 8, marginBottom: 8, flexWrap: "wrap", alignItems: "center" }}>
          <button
            className="battlemap-button"
            title="Add layer"
            onClick={() => props.onCreateLayer(null)}
            style={{ padding: "6px 10px", display: "inline-flex", alignItems: "center", justifyContent: "center" }}
          >
            <PlusIcon />
          </button>
          <button className="battlemap-button" title="Add group" onClick={() => props.onCreateGroup(null)} style={{ padding: "6px 10px", display: "inline-flex", alignItems: "center", justifyContent: "center" }}>
            <FolderIcon />
          </button>
          <button
            className="battlemap-button"
            title={lockState.action === "lock" ? "Lock selected" : "Unlock selected"}
            disabled={!lockState.anySelected}
            onClick={toggleLockForSelection}
            style={{ padding: "6px 10px", color: "#111", display: "inline-flex", alignItems: "center", justifyContent: "center", gap: 6 }}
          >
            <LockIcon locked={lockState.action === "unlock"} />
          </button>
          {selectedLayerIds.length > 0 ? (
            <button
              className="battlemap-button"
              title="Delete selected"
              onClick={() => props.onDeleteLayers(selectedLayerIds)}
              style={{ padding: "6px 10px" }}
            >
              ðŸ—‘
            </button>
          ) : null}
        </div>

        <div style={{ flex: 1, minHeight: 0, overflowY: "auto", paddingRight: 4 }}>
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            {flat.map(({ node, depth }) => (
              <LayerRow
                key={node.id}
                node={node}
                depth={depth}
                isSelected={selectedLayerIds.includes(node.id)}
                soloActive={!!soloLayerId}
                isSolo={soloLayerId === node.id}
                onClick={handleRowClick}
                onVisibilityClick={(e, id) => {
                  if (e.altKey) {
                    props.onSoloLayerChange(soloLayerId === id ? null : id);
                  } else {
                    props.onToggleVisibility(id);
                  }
                }}
                onToggleExpand={(id) => {
                  const n = layers.nodes[id];
                  if (n?.type !== "group") return;
                  props.onLayersChange({
                    ...layers,
                    nodes: { ...layers.nodes, [id]: { ...n, expanded: !n.expanded } as LayerGroup },
                  });
                }}
                onDelete={(id) => props.onDeleteLayers([id])}
              />
            ))}
          </div>
        </div>
      </div>

    </div>
  );
};

export default BattlemapLayersPanel;
